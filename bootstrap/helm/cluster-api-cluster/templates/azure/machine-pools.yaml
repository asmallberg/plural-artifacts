{{- if and (eq .Values.provider "azure") (eq .Values.type "managed") -}}
{{- $currentScope := . -}}
{{- $defaultVals := .Values.workers.defaults.azure -}}
{{- range $name, $values := .Values.workers.azure }}
{{- with $currentScope}}
{{- $scaling := ($values.spec | default dict).scaling | default $defaultVals.spec.scaling }}
{{- if $scaling }}
{{- if not (and (hasKey $scaling "minSize") (hasKey $scaling "maxSize")) }}
  {{- fail (printf "Invalid value for scaling. Both minSize and maxSize must be set") }}
{{- end }}
{{- end }}
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AzureManagedMachinePool
metadata:
  annotations:
    {{- if (hasKey $values "annotations") -}}
    {{- toYaml (merge $values.annotations $defaultVals.annotations)| nindent 4 }}
    {{- else -}}
    {{- toYaml $defaultVals.annotations | nindent 4 }}
    {{- end }}
  labels:
    {{- if (hasKey $values "labels") -}}
    {{- toYaml (merge $values.labels $defaultVals.labels)| nindent 4 }}
    {{- else -}}
    {{- toYaml $defaultVals.labels | nindent 4 }}
    {{- end }}
  name: {{ $name }}
spec:
  name: {{ $name }}
  additionalTags: {} # TODO: Set.
  mode: {{ ($values.spec | default dict).mode | default $defaultVals.spec.mode }}
  sku: {{ ($values.spec | default dict).sku | default $defaultVals.spec.sku }}
  osDiskSizeGB: {{ ($values.spec | default dict).osDiskSizeGB | default $defaultVals.spec.osDiskSizeGB }}
  {{- if or ($defaultVals.spec.availabilityZones) (($values.spec | default dict).availabilityZones) }}
  availabilityZones:
    {{- toYaml (($values.spec | default dict).availabilityZones | default $defaultVals.spec.availabilityZones) | nindent 2 }}
  {{- end }}
  nodeLabels: {} # TODO: Set.
  taints: [] # TODO: Set.
  {{- if $scaling }}
  scaling:
    {{- toYaml $scaling | nindent 4 }}
  {{- end }}
  maxPods: {{ ($values.spec | default dict).maxPods | default $defaultVals.spec.maxPods }}
  osDiskType: {{ ($values.spec | default dict).osDiskType | default $defaultVals.spec.osDiskType }}
  scaleSetPriority: {{ ($values.spec | default dict).maxPods | default $defaultVals.spec.scaleSetPriority }}
{{- end }}
---
{{- end }}
{{ end }}
